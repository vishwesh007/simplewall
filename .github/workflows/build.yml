# Build and Release workflow for simplewall
# Automatically builds when changes are pushed and creates releases

name: Build

on:
  push:
    branches: [ master ]
    paths:
      - 'src/**'
      - 'routine/**'
      - '*.vcxproj*'
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release'
        required: false
        default: 'false'
        type: boolean

env:
  SOLUTION_FILE: simplewall.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: x64

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore ${{ env.SOLUTION_FILE }}

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $versionLine = Get-Content VERSION | Select-String "simplewall=(\d+\.\d+\.\d+)"
          $version = $versionLine.Matches[0].Groups[1].Value
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Build x64
        run: |
          msbuild ${{ env.SOLUTION_FILE }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=x64 /m

      - name: Create portable package
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $outDir = "artifacts/simplewall-$version-portable"
          New-Item -ItemType Directory -Force -Path $outDir
          Copy-Item "bin/64/simplewall.exe" $outDir
          Copy-Item "bin/*.txt" $outDir
          Copy-Item "bin/*.lng" $outDir
          Copy-Item "bin/*.sp" $outDir
          Copy-Item "bin/*.xml" $outDir
          Copy-Item -Recurse "bin/i18n" $outDir
          New-Item -ItemType File -Path "$outDir/portable.dat" -Value "#PORTABLE#"
          Compress-Archive -Path "$outDir/*" -DestinationPath "artifacts/simplewall-$version-bin.zip"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simplewall-${{ steps.version.outputs.version }}
          path: |
            artifacts/*.zip
            bin/64/simplewall.exe
            bin/64/simplewall.pdb

  release:
    needs: build
    if: github.event.inputs.create_release == 'true' || (github.event_name == 'push' && contains(github.event.head_commit.message, '[release]'))
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $versionLine = Get-Content VERSION | Select-String "simplewall=(\d+\.\d+\.\d+)"
          $version = $versionLine.Matches[0].Groups[1].Value
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: simplewall-${{ steps.version.outputs.version }}
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: simplewall v${{ steps.version.outputs.version }}
          draft: true
          prerelease: false
          files: |
            artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
